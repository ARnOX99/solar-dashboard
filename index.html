<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Tracker Dashboard - IoT Monitoring System</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header with Solar Model Image -->
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1>‚òÄÔ∏è Solar Tracker Dashboard</h1>
                    <p>Real-time IoT monitoring and control system</p>
                </div>
                <div class="header-image">
                    <img src="images/solar-model.jpg" alt="Solar Tracker Model" id="solarModelImg" onerror="this.style.display='none'">
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('live')">üìä Live Readings</button>
            <button class="tab" onclick="switchTab('history')">üìà Past Readings</button>
            <button class="tab" onclick="switchTab('datatable')">üìã Data Table</button>
            <button class="tab" onclick="switchTab('alerts')">üîî Alerts</button>
            <button class="tab" onclick="switchTab('control')">üéõÔ∏è Controls</button>
            <button class="tab" onclick="switchTab('about')">‚ÑπÔ∏è About</button>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- Live Readings Tab -->
            <div id="live" class="tab-content active">
                <div class="status-bar">
                    <div class="status-badge active" id="systemStatus">
                        <div class="status-dot"></div>
                        <span>System Active</span>
                    </div>
                    <div class="last-update" id="lastUpdate">Last updated: Never</div>
                </div>

                <div class="readings-grid">
                    <div class="reading-card">
                        <div class="reading-label">‚òÄÔ∏è Light Intensity (BH1750)</div>
                        <div class="reading-value" id="bhLux">0</div>
                        <div class="reading-unit">lux</div>
                    </div>

                    <div class="reading-card">
                        <div class="reading-label">‚ÜîÔ∏è Horizontal Error</div>
                        <div class="reading-value" id="hError">0</div>
                        <div class="reading-unit">units</div>
                    </div>

                    <div class="reading-card">
                        <div class="reading-label">‚ÜïÔ∏è Vertical Error</div>
                        <div class="reading-value" id="vError">0</div>
                        <div class="reading-unit">units</div>
                    </div>

                    <div class="reading-card">
                        <div class="reading-label">üîÑ Servo X (Horizontal)</div>
                        <div class="reading-value" id="servoX">90</div>
                        <div class="reading-unit">degrees</div>
                    </div>

                    <div class="reading-card">
                        <div class="reading-label">üîÑ Servo Y (Vertical)</div>
                        <div class="reading-value" id="servoY">90</div>
                        <div class="reading-unit">degrees</div>
                    </div>

                    <div class="reading-card">
                        <div class="reading-label">‚ö° Solar Voltage</div>
                        <div class="reading-value" id="solarV">0.00</div>
                        <div class="reading-unit">V</div>
                    </div>

                    <div class="reading-card">
                        <div class="reading-label">‚ö° Solar Current</div>
                        <div class="reading-value" id="solarI">0.00</div>
                        <div class="reading-unit">mA</div>
                    </div>

                    <div class="reading-card">
                        <div class="reading-label">üîã Battery Voltage</div>
                        <div class="reading-value" id="battV">0.00</div>
                        <div class="reading-unit">V</div>
                    </div>

                    <div class="reading-card">
                        <div class="reading-label">üí° Solar Power (Calculated)</div>
                        <div class="reading-value" id="solarP">0.00</div>
                        <div class="reading-unit">mW</div>
                    </div>

                    <div class="reading-card">
                        <div class="reading-label">üì° Average LDR</div>
                        <div class="reading-value" id="avgLDR">0</div>
                        <div class="reading-unit">units</div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>Individual LDR Sensors</h3>
                    <div class="ldr-grid">
                        <div class="ldr-box">
                            <strong>üåÖ West:</strong> <span id="ldrW">0</span>
                        </div>
                        <div class="ldr-box">
                            <strong>üåÑ East:</strong> <span id="ldrE">0</span>
                        </div>
                        <div class="ldr-box">
                            <strong>‚¨ÜÔ∏è Left:</strong> <span id="ldrL">0</span>
                        </div>
                        <div class="ldr-box">
                            <strong>‚¨áÔ∏è Right:</strong> <span id="ldrR">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Past Readings Tab -->
            <div id="history" class="tab-content">
                <h2 style="margin-bottom: 20px;">üìà Historical Trends (Last 100 Readings)</h2>

                <!-- Compact 2-column grid for individual graphs -->
                <div class="charts-grid">
                    <!-- Light Intensity Chart -->
                    <div class="chart-container-compact">
                        <div class="chart-title-compact">‚òÄÔ∏è Light Intensity</div>
                        <canvas id="chartIntensity"></canvas>
                    </div>

                    <!-- Horizontal Error Chart -->
                    <div class="chart-container-compact">
                        <div class="chart-title-compact">‚ÜîÔ∏è Horizontal Error</div>
                        <canvas id="chartHError"></canvas>
                    </div>

                    <!-- Vertical Error Chart -->
                    <div class="chart-container-compact">
                        <div class="chart-title-compact">‚ÜïÔ∏è Vertical Error</div>
                        <canvas id="chartVError"></canvas>
                    </div>

                    <!-- Servo X Chart -->
                    <div class="chart-container-compact">
                        <div class="chart-title-compact">üîÑ Servo X Position</div>
                        <canvas id="chartServoX"></canvas>
                    </div>

                    <!-- Servo Y Chart -->
                    <div class="chart-container-compact">
                        <div class="chart-title-compact">üîÑ Servo Y Position</div>
                        <canvas id="chartServoY"></canvas>
                    </div>

                    <!-- Solar Voltage Chart -->
                    <div class="chart-container-compact">
                        <div class="chart-title-compact">‚ö° Solar Voltage</div>
                        <canvas id="chartVoltage"></canvas>
                    </div>

                    <!-- Solar Current Chart -->
                    <div class="chart-container-compact">
                        <div class="chart-title-compact">‚ö° Solar Current</div>
                        <canvas id="chartCurrent"></canvas>
                    </div>

                    <!-- Battery Voltage Chart -->
                    <div class="chart-container-compact">
                        <div class="chart-title-compact">üîã Battery Voltage</div>
                        <canvas id="chartBattery"></canvas>
                    </div>

                    <!-- Solar Power Chart (Calculated) -->
                    <div class="chart-container-compact">
                        <div class="chart-title-compact">üí° Solar Power (Calculated)</div>
                        <canvas id="chartPower"></canvas>
                    </div>

                    <!-- Average LDR Chart -->
                    <div class="chart-container-compact">
                        <div class="chart-title-compact">üì° Average LDR</div>
                        <canvas id="chartAvgLDR"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table Tab -->
            <div id="datatable" class="tab-content">
                <h2 style="margin-bottom: 20px;">üìã Historical Data Table & Export</h2>

                <!-- Data Controls -->
                <div class="data-controls">
                    <div class="control-group">
                        <label for="dataRange">üìÖ Data Range:</label>
                        <select id="dataRange" onchange="loadDataTable()">
                            <option value="100">Last 100 readings (~33 mins)</option>
                            <option value="300">Last 300 readings (~1.5 hours)</option>
                            <option value="500">Last 500 readings (~2.8 hours)</option>
                            <option value="1000">Last 1000 readings (~5.5 hours)</option>
                            <option value="3000">Last 3000 readings (~16.7 hours)</option>
                            <option value="8000" selected>Last 8000 readings (~44 hours)</option>
                            <option value="12960">Last 12960 readings (72 hours - 3 days) ‚≠ê</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <button class="btn btn-primary" onclick="loadDataTable()">üîÑ Refresh Data</button>
                        <button class="btn btn-success" onclick="exportToCSV()"> Download CSV</button>
                        <button class="btn btn-warning" onclick="exportToExcel()"> Download Excel</button>
                        <button class="btn btn-info" onclick="checkDataQuality()"> Check Quality</button>
                    </div>
                </div>

                <!-- Statistics Summary -->
                <div class="stats-summary">
                    <div class="stat-box">
                        <div class="stat-label">Total Readings</div>
                        <div class="stat-value" id="totalReadings">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Avg Power (mW)</div>
                        <div class="stat-value" id="avgPower">0.00</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Energy (Wh)</div>
                        <div class="stat-value" id="totalEnergy">0.00</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Peak Power (mW)</div>
                        <div class="stat-value" id="peakPower">0.00</div>
                    </div>
                </div>

                <!-- Data Quality Indicator -->
                <div id="dataQuality" style="text-align: center; background: #dbeafe; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: none;">
                    <strong>Data Quality:</strong> Calculating...
                </div>

                <!-- Search and Filter -->
                <div class="table-controls">
                    <input type="text" id="searchBox" placeholder="üîç Search data..." onkeyup="filterTable()">
                    <span id="tableInfo">Showing <strong id="rowCount">0</strong> readings</span>
                </div>

                <!-- Warning for Null Data -->
                <div id="dataWarning" style="display: none; background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                    ‚ö†Ô∏è Some readings contain missing data (shown with 0 values). This is normal when sensors are initializing or during transmission errors.
                </div>

                <!-- Data Table -->
                <div class="table-container">
                    <table id="dataTable" class="data-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">#</th>
                                <th onclick="sortTable(1)">Timestamp ‚áÖ</th>
                                <th onclick="sortTable(2)">Light (lux) ‚áÖ</th>
                                <th onclick="sortTable(3)">H Error ‚áÖ</th>
                                <th onclick="sortTable(4)">V Error ‚áÖ</th>
                                <th onclick="sortTable(5)">Servo X¬∞ ‚áÖ</th>
                                <th onclick="sortTable(6)">Servo Y¬∞ ‚áÖ</th>
                                <th onclick="sortTable(7)">Voltage (V) ‚áÖ</th>
                                <th onclick="sortTable(8)">Current (mA) ‚áÖ</th>
                                <th onclick="sortTable(9)">Power (mW) ‚áÖ</th>
                                <th onclick="sortTable(10)">Batt (V) ‚áÖ</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr>
                                <td colspan="11" style="text-align: center; padding: 40px;">
                                    <div class="spinner"></div>
                                    <p>Click "Refresh Data" to load readings from ThingSpeak</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="pagination">
                    <button onclick="changePage(-1)">‚Üê Previous</button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button onclick="changePage(1)">Next ‚Üí</button>
                </div>
            </div>

            <!-- Alerts Tab -->
            <div id="alerts" class="tab-content">
                <h2 style="margin-bottom: 20px;">üîî System Alerts & Notifications</h2>

                <div id="alertsContainer">
                    <div class="alert info">
                        <span style="font-size: 1.5em;">‚ÑπÔ∏è</span>
                        <span>No alerts at this time. System operating normally.</span>
                    </div>
                </div>

                <div class="info-section">
                    <h3>Smart Cleaning Alert System</h3>
                    <p><strong>How it works:</strong></p>
                    <ul>
                        <li>Calibrates both BH1750 and LDR sensors when panel is clean</li>
                        <li>Continuously monitors actual solar current vs expected current</li>
                        <li>Calculates expected current based on current light intensity</li>
                        <li>Triggers alert when actual current drops 30% below expected</li>
                        <li>Cross-validates with both sensors to prevent false alarms</li>
                    </ul>
                </div>

                <div class="controls">
                    <button class="btn btn-primary" onclick="setBaseline()">üéØ Set Clean Panel Baseline</button>
                    <button class="btn btn-warning" onclick="checkCleaning()">üßº Check Cleaning Status</button>
                </div>

                <div id="cleaningStatus" class="info-section" style="display: none;">
                    <h3>Cleaning Analysis</h3>
                    <p id="cleaningDetails">Analyzing...</p>
                </div>
            </div>

            <!-- Controls Tab -->
            <div id="control" class="tab-content">
                <h2 style="margin-bottom: 20px;">üéõÔ∏è System Controls</h2>

                <div class="info-section">
                    <h3>Battery Management</h3>
                    <p>Manually switch between battery sources or enable automatic mode.</p>
                    <div class="controls">
                        <button class="btn btn-success" onclick="sendCommand('BATT1')">üîã Battery 1</button>
                        <button class="btn btn-success" onclick="sendCommand('BATT2')">üîã Battery 2</button>
                        <button class="btn btn-primary" onclick="sendCommand('AUTO')">üîÑ Auto Mode</button>
                    </div>
                </div>

                <div class="info-section">
                    <h3>Calibration</h3>
                    <p>Set baseline readings when solar panel is freshly cleaned.</p>
                    <div class="controls">
                        <button class="btn btn-warning" onclick="sendCommand('BASELINE')">üéØ Set Baseline</button>
                    </div>
                </div>

                <div class="info-section">
                    <h3>Power Saving Mode</h3>
                    <p><strong>Automatic Energy Saving</strong></p>
                    <ul>
                        <li>Activates when light intensity drops below threshold for 10 minutes</li>
                        <li>Stops servo movement to conserve battery power</li>
                        <li>Continues sensor monitoring at reduced frequency</li>
                        <li>Automatically resumes tracking when sunlight returns</li>
                    </ul>
                    <div class="alert info">
                        <span>‚ÑπÔ∏è</span>
                        <span>Power save mode is fully automatic. Current status: <strong id="powerStatus">Active</strong></span>
                    </div>
                </div>
            </div>

            <!-- About Tab -->
            <div id="about" class="tab-content">
                <h2 style="margin-bottom: 20px;">‚ÑπÔ∏è About Solar Tracker System</h2>

                <div class="info-section">
                    <h3>System Overview</h3>
                    <p>This dual-axis solar tracking system optimizes solar panel orientation to maximize energy harvesting throughout the day. The system uses multiple sensors and intelligent algorithms to track the sun's position and monitor panel performance.</p>
                </div>

                <!-- Block Diagram -->
                <div class="info-section">
                    <h3>Block Diagram</h3>
                    <div class="diagram-container">
                        <img src="images/block-diagram.png" alt="System Block Diagram" class="diagram-img" onerror="this.style.display='none'">
                    </div>
                </div>

                <!-- Circuit Diagram -->
                <div class="info-section">
                    <h3>Circuit Diagram</h3>
                    <div class="diagram-container">
                        <img src="images/circuit-diagram.png" alt="Circuit Diagram" class="diagram-img" onerror="this.style.display='none'">
                    </div>
                </div>

                <div class="info-section">
                    <h3>Hardware Components</h3>
                    <ul>
                        <li><strong>Arduino Uno:</strong> Main controller for sensors and servos</li>
                        <li><strong>ESP8266 (ESP-01):</strong> WiFi connectivity and cloud communication</li>
                        <li><strong>4√ó LDR Sensors:</strong> Light direction detection (West, East, Left, Right)</li>
                        <li><strong>BH1750:</strong> Digital light intensity sensor (calibrated lux readings)</li>
                        <li><strong>INA219:</strong> Solar panel voltage and current monitoring</li>
                        <li><strong>2√ó Servos:</strong> Dual-axis panel positioning (SG90 or MG996R)</li>
                        <li><strong>Relay Module (2-channel):</strong> Battery switching control</li>
                        <li><strong>2√ó 18650 Lithium Batteries:</strong> Energy storage with automatic switching</li>
                        <li><strong>TP4056:</strong> Battery charging module</li>
                        <li><strong>AMS1117:</strong> 3.3V voltage regulator for ESP8266</li>
                        <li><strong>Buck Converter:</strong> 9V to 5V for servo power</li>
                    </ul>
                </div>

                <div class="info-section">
                    <h3>Key Features</h3>
                    <ul>
                        <li> Real-time dual-axis sun tracking</li>
                        <li> Cloud-based monitoring via ThingSpeak</li>
                        <li> Smart cleaning alerts using dual-sensor validation</li>
                        <li> Automatic power saving during night/cloudy periods</li>
                        <li> Remote battery management</li>
                        <li> Comprehensive data logging and visualization</li>
                        <li> Cross-platform web dashboard (mobile & desktop)</li>
                        <li> Real-time alerts and notifications</li>
                        <li> Exportable data tables (CSV/Excel)</li>
                        <li> Up to 72 hours of historical data</li>
                    </ul>
                </div>

                <div class="info-section">
                    <h3>Data Collection & Monitoring</h3>
                    <p><strong>Sensors read every 500ms, data sent to cloud every 20 seconds:</strong></p>
                    <ul>
                        <li>Light intensity (BH1750 digital sensor in lux)</li>
                        <li>Horizontal and vertical tracking errors</li>
                        <li>Individual LDR readings for diagnostics</li>
                        <li>Servo positions (X and Y axis in degrees)</li>
                        <li>Solar panel voltage and current (Power calculated on website)</li>
                        <li>Battery voltage monitoring</li>
                        <li>System mode (Active/Power Save)</li>
                    </ul>
                </div>

                <div class="info-section">
                    <h3>Project Team</h3>
                    <p>Developed as an advanced IoT solar energy harvesting and monitoring system.</p>
                    <p><strong>GitHub Repository:</strong> <a href="https://github.com/arnox99/solar-dashboard" target="_blank">github.com/arnox99/solar-dashboard</a></p>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
